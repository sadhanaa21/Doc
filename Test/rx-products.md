# RX Products

If an order includes RX products (prescription), it should be transferred to a specific facility. This process involves utilizing the OMS API for updating order items' ship group, specifically the updateOrderItemShipGroup service. Once the order is successfully moved to a required facility, an order attribute named RX\_PRODUCT\_VERIFIED will be created. Importantly, this attribute is also created directly for non-RX products without any additional updates.

### NiFi Flow -

The NiFi processors to order attributes for RX products -

* The **ExecuteSQLRecord** processor is utilized to execute a SQL query.
* The file is then split into individual JSON objects by the **SplitJSON** processor.
* The **SplitJSON** processor generates two significant attributes: `fragment.count` and `fragment.identifier`.
* These JSON objects serve as the request body for API calls.
* For each JSON object, a POST request is made to the specified API endpoint using the **InvokeHTTP** processor.
* The **RouteOnAttribute** processor is configured with two dynamic properties: Failure and Success. Any status code other than 200 is considered a failure.
* Two relations are established based on these properties:

**Success:**

* In the success relations, the subsequent processor is **Wait**, which stays waiting until it receives notification from the **Notify** processor.
* Following a **MergeRecord** processor which will merge all the incoming flow files, the default fields along with required values are added here.
* Updating the file name using the **UpdateAttribute** processor.
* The file is kept on SFTP using the **PutSFTP** processor.

**Failure:**

* In the case of Failure relations, the subsequent processor is **Wait**, which stays waiting until it receives notification from the **Notify** processor.
* The coordination between **Wait** and **Notify** is facilitated through the use of the DistributedMapCacheService controller service and utilities the `fragment.count` and `fragment.identifier` attributes.
* Following the **Wait**, the **UpdateRecord** processor is used to log the orderId and its corresponding response generated by the API call.
* Finally, all the failure flow files are merged and placed under a directory named "http\_error\_log" using the **PutSFTP** processor.

**Failure, Success, and Unmatched:**

* For the combined Failure, Success, and Unmatched relations, the next processor is **UpdateRecord**. This processor adds the response corresponding to the orderId in the flow file.
* Subsequently, the **MergeRecord** processor is utilized with the Merge Strategy set to Defragment, waiting until the `fragment.count` becomes equal.
* For all the failure and original relations from **MergeRecord**, there is a Notify processor, and for all merged relations, there are **UpdateAttribute** and **PutSFTP** processors, directing flow files under the directory named "http\_log."
